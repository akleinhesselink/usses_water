---
layout: 11pt
header-includes:
  - \usepackage{lineno}
  - \linenumbers
  - \usepackage{setspace}
  - \usepackage{todonotes}
  - \onehalfspacing
  - \usepackage{rotating}
  - \usepackage{color, soul}
  - \usepackage[font={small},labelfont={bf},labelsep=quad]{caption}
  - \usepackage{tikz}
  - \usepackage{bm,mathrsfs}
  - \usepackage[sc]{mathpazo}
bibliography: ~/Dropbox/Bibliography/usses_water.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: false
    number_sections: true
fontsize: 11pt
geometry: margin=1in
linkcolor: black
urlcolor: black
---

\newcommand{\tikzcircle}[2][red,fill=red]{\tikz[baseline=-0.5ex]\draw[#1,radius=#2] (0,0) circle ;}
\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\renewcommand\thefigure{A2-\arabic{figure}}
\renewcommand\theequation{A2.\arabic{equation}}
\renewcommand\thetable{A2-\arabic{table}}  
\renewcommand\thesection{Section A2.\arabic{section}}

\begin{center}
\textbf{\Large{Appendix 2}} \\
A.T. Tredennick, A.R. Kleinhesselink, \& P.B. Adler \\
``Ecosystem and community resistance...'' \\
\emph{PeerJ}
\end{center}

\section{Random Slopes, Random Intercepts Model}
\subsection{Model Description}
Our hierarchical Bayesian model with random intercepts and random slopes allowed us to test for differences among treatments in the relationship between ANPP and growing season precipitation, and allowed us to account for the non-independence of observations through time within a plot.
The random effects structure mirrors the nested structure of the data: plot-level parameters are nested within treatment-level parameters, which are nested within overall parameters.
In what follows, $\textbf{X}$ is the design matrix including a column of 1s for intercepts and a column of precipitation values for each observation, $\textbf{y}$ is a row vector of log(ANPP) values for each observation, *j* references plots, *k* references treatment, and *t* references year.
The notation *j(k(t))* reads as 'observation of plot *j* associated with treatment *k* within year *t*'.
Recall we have three treatments: drought (~50\% decrease in precipitation), control (ambient precipitation), and irrigation (~50\% increase in precipitation).

We assume the observations are conditionally Gaussian,

\vspace{-2em}

\begin{align}
y_{j(k(t))} \sim \text{Normal}\left(\mu_{j(k(t))}, \sigma^2_k \right),
\end{align}

\noindent{}where $\mu_{j(k(t))}$ is the determinstic expectation from the regression model,

\vspace{-2em}

\begin{align}
\mu_{j(k(t))} = \textbf{x}_{k(t)}'\boldsymbol{\beta_{j(k)} + \gamma_{t}}.
\end{align}

The intercept and slope in the parameter vector $\boldsymbol{\beta}$ were modeled hierarchically,

\vspace{-2em}

\begin{align}
\boldsymbol{\beta}_{j(k)} &\sim \text{MVN} \left( \boldsymbol{\beta}_k, \boldsymbol{\Sigma}(k) \right), \\
\boldsymbol{\beta}_{k} &\sim \text{MVN} \left( \boldsymbol{\beta}, \boldsymbol{\Sigma}  \right), \\
\boldsymbol{\beta} &\sim \text{Normal} \left( 0, 1 \right),
\end{align}

\noindent{} where $\boldsymbol{\beta}_{j(k)}$ is the vector of regression coefficients (intercept and slope) for plot *j* associated with treatment *k*, $\boldsymbol{\beta}_{k}$ is the vector of coefficients for each treatment, and $\boldsymbol{\beta}$ is the vector of overall coefficients.
The plot- and treatment-level coefficients are drawn from multivariate normal distributions with covariance matrix $\boldsymbol{\Sigma}$.
For the plot-level coefficients, each treatment has its own variance-covariance matrix (i.e., $\boldsymbol{\Sigma}(k)$).
The overall coefficients are drawn from a normal prior with mean 0 and standard deviation 1.

The random year effects ($\boldsymbol{\gamma}$) are modeled as intercept offsets centered on zero with a shared variance ($\sigma_{yr}$),

\vspace{-2em}

\begin{align}
\boldsymbol{\gamma} \sim \text{Normal} \left( 0, \sigma_{yr}  \right).
\end{align}

We fit the model using MCMC as implemented in the software Stan [@stan2016].
Our Stan code is below.
All code necessary to reproduce our results has been archived on Figshare (*link here*) and released on GitHub (https://github.com/atredennick/usses_water/releases/v0.1).

\newpage{}

\subsection{Stan Code}
```{r stan1, echo=T, eval=F}
data {
  int<lower=0> Npreds;        # number of covariates, including intercept
  int<lower=0> Nplots;        # number of plots
  int<lower=0> Ntreats;       # number of treatments
  int<lower=0> Nobs;          # number of observations
  int<lower=0> Nppts;         # Number of precip levels to predict
  int<lower=0> Nyears;        # Number of years
  vector[Nobs] y;             # vector of observations
  row_vector[Npreds] x[Nobs]; # design matrix
  matrix[Nppts,Npreds] newx;  # design matrix for predictions 
  matrix[Npreds,Npreds] R;	  # priors for covariance matrix
  int plot_id[Nobs];          # vector of plot ids
  int treat_id[Nobs];         # vector of treatment ids
  int year_id[Nobs];          # vector of year ids
}

parameters {
  vector[Npreds] beta_plot[Nplots]; # a unique vector matrix for each plot
  vector[Npreds] beta_treat[Ntreats]; # a unique vector matrix for each treatment
	vector[Npreds] beta_mu; # overall coefficients
	vector[Nyears] year_off; # vector of year effects
	cov_matrix[Npreds] Sigma; # covariance matrix for treatment-level coefficients
	cov_matrix[Npreds] Sigma_plot[Ntreats]; # unique covariance matrix for plot-level coefficients for each treatment
	vector<lower=0>[Ntreats] sd_y; # treatment-level observation std. dev.
	vector<lower=0>[Nyears] sigma_year; # year std. dev. hyperprior
}

transformed parameters {
  vector[Nobs] yhat; # vector of expected values (predictions)
  for (i in 1:Nobs)
    # regression model for expected values (one for each plot-year)
    yhat[i] = x[i]*beta_plot[plot_id[i]] + year_off[year_id[i]];
}

model {
  ####  PRIORS
  for(i in 1:Nplots)
    # plot-level coefficients vary normally around treatment coefs
		beta_plot[i] ~ multi_normal(beta_treat[treat_id[i]], Sigma_plot[treat_id[i]]);
	
	for(i in 1:Ntreats){
	  # treatment-level coefficients vary normally around overall coefficients
	  beta_treat[i] ~ multi_normal(beta_mu, Sigma);
	  Sigma_plot[i] ~ inv_wishart(Npreds+1, R); # priors on covariance of effects at plot-level
	}
	
	beta_mu ~ normal(0,1); # priors on overall effects
	year_off ~ normal(0,sigma_year); # priors on year effects, shared variance
	Sigma ~ inv_wishart(Npreds+1, R); # priors on covariance of effects at treatment-level
	sd_y ~ weibull(2,1); # priors on observation std. dev. for each treatment
	sigma_year ~ weibull(2,1); # hyperprior on year std. dev.

	####  LIKELIHOOD
  for(i in 1:Nobs)
    # observations vary normally around expected values
    y[i] ~ normal(yhat[i], sd_y[treat_id[i]]); 
}

generated quantities {
  vector[Nppts] ypreds[Ntreats];
  vector[Nppts] ydiff_control_drought;
  vector[Nppts] ydiff_control_irrigate;
  vector[2] inter_diffs;
  for(i in 1:Ntreats)
    ypreds[i] = newx*beta_treat[i]; # mean predictions for each treatment
  
  # difference between mean predictions
  ydiff_control_drought = ypreds[1] - ypreds[2]; 
  ydiff_control_irrigate = ypreds[1] - ypreds[3];
  
  # difference between control and treatment in avg ppt year
  inter_diffs[1] = beta_treat[1][1] - beta_treat[2][1]; # control - drought
  inter_diffs[2] = beta_treat[1][1] - beta_treat[3][1]; # control - irrigation
}

```

\newpage{}

# Figures

```{r hrv, fig.cap="Scatterplot, on the arithmetic scale, of the data and model estimates shown a solid lines. Model estimates come from treatment level coefficients (colored lines) and the overall mean coefficients (heavy black line).", echo=FALSE, message=FALSE}
library(tidyverse)
library(dplyr)
library(stringr)
library(ggplot2)
library(ggthemes)

source("../code/read_format_data.R") # load data
all_fit <- readRDS("../results/randcoefs_alltreatments_fit.RDS")

lmod <- lm(log(anpp) ~ total_seasonal_vwc, anpp_data)
x <- model.matrix(lmod)
newx <- as.data.frame(unique(x)) %>% select(total_seasonal_vwc)
newx$vwc_id <- c(1:nrow(newx))
mean_log_anpp <- mean(log(anpp_data$anpp))
sd_log_anpp <- sd(log(anpp_data$anpp))
model_preds <- reshape2::melt(rstan::extract(all_fit, pars="ypreds_mu")) %>%
  rename(iteration = iterations, vwc_id = Var2, estimate = value, stan_name = L1) %>%
  left_join(newx, by="vwc_id") %>%
  group_by(total_seasonal_vwc) %>%
  summarise(mean_estimate = mean(estimate*sd_log_anpp+mean_log_anpp)) %>%
  mutate(backtrans_estimate = mean_estimate) %>%
  ungroup()

trt_vwc <- data.frame(treatment = rep(c("Control","Drought","Irrigation"), each = nrow(newx)),
                      treat_id = rep(c(1:3), each = nrow(newx)),
                      vwc = rep(newx$total_seasonal_vwc, times = 3),
                      vwc_id = rep(newx$vwc_id, times = 3))
treat_preds <- reshape2::melt(rstan::extract(all_fit, pars="ypreds")) %>%
  rename(iteration = iterations, treat_id = Var2, vwc_id = Var3, estimate = value, stan_name = L1) %>%
  left_join(trt_vwc, by = c("vwc_id","treat_id")) %>%
  group_by(treatment, vwc) %>%
  summarise(mean_estimate = mean(estimate*sd_log_anpp+mean_log_anpp)) %>%
  mutate(backtrans_estimate = mean_estimate) %>%
  ungroup()


ggplot(anpp_data, aes(x=total_seasonal_vwc,y=anpp))+
  geom_point(shape=21,color="grey25",alpha=0.8,aes(fill=Treatment))+
  geom_line(data=treat_preds, aes(x=vwc, y=exp(backtrans_estimate), color=treatment))+
  geom_line(data=model_preds, aes(x=total_seasonal_vwc, y=exp(backtrans_estimate)), size=1)+
  scale_fill_brewer(palette = "Set2")+
  scale_color_brewer(palette = "Set2")+
  #scale_x_continuous(limits=c(100,300),breaks=seq(100,300,50))+
  #scale_y_continuous(breaks=seq(50,350,50))+
  xlab("March-June Cumulative VWC")+
  ylab(expression(paste("ANPP (g ",m^2,")")))+
  guides(fill=FALSE,color=FALSE)+
  theme_bw()+
  theme(panel.grid.minor = element_blank())

```


# References
